// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema
// Database: Supabase Postgres

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")   // pooler — used at runtime
  directUrl = env("DIRECT_URL")     // direct — used for prisma db push / migrations
}

// User (Admin/Developer) 
// In "Team Mode", this is the Team Admin. 
// In "Fork Mode", this is the individual developer.
model User {
  id        String   @id @default(cuid())
  githubId  String   @unique
  email     String?
  name      String?
  avatarUrl String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  projects  Project[]
}

// A Connected Repository (Source of Truth)
model Project {
  id          String   @id @default(cuid())
  ownerId     String
  owner       User     @relation(fields: [ownerId], references: [id])
  
  // GitHub Info
  repoName    String   // e.g. "my-project"
  repoOwner   String   // e.g. "my-org"
  repoUrl     String
  githubRepoId Int     @unique // The unique ID from GitHub
  
  // Settings
  installationId String? // The GitHub App Installation ID
  
  rules       Rule[]
  analyses    Analysis[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// The Core: A Compliance Rule
model Rule {
  id          String   @id @default(cuid())
  projectId   String
  project     Project  @relation(fields: [projectId], references: [id])

  // The "English" definition
  description String   // e.g. "Variable names must be camelCase"
  language    String   // e.g. "javascript", "java", "python"

  // The "Tree-sitter" definition (Generated by AI, Verified by Admin)
  treeSitterQuery String  @db.Text // The actual Scheme-like query: (identifier) @name ...
  
  // AI Context
  aiExplanation   String? @db.Text // Why this query works (for Admin review)
  
  // Enforcement
  severity        Severity @default(WARNING)
  isActive        Boolean  @default(true)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// Audit Log of Runs
model Analysis {
  id          String   @id @default(cuid())
  projectId   String
  project     Project  @relation(fields: [projectId], references: [id])
  
  prNumber    Int
  commitHash  String
  
  status      AnalysisStatus
  
  violations  Violation[]

  createdAt   DateTime @default(now())
}

model Violation {
  id          String   @id @default(cuid())
  analysisId  String
  analysis    Analysis @relation(fields: [analysisId], references: [id])
  
  ruleId      String?
  filePath    String
  lineNumber  Int
  message     String
  
  createdAt   DateTime @default(now())
}

enum Severity {
  WARNING
  CRITICAL // Creates Jira Ticket
}

enum AnalysisStatus {
  PENDING
  SUCCESS
  FAILURE
}

// ============================================================
// LANGUAGE-INDEPENDENT RULE ARCHITECTURE
// ============================================================

// Abstract Rule - Language-independent rule definition
// Defines WHAT to detect, not HOW (language-specific)
model AbstractRule {
  id          String       @id @default(cuid())
  name        String       @unique  // "no-eval", "no-hardcoded-secrets"
  displayName String                // "No Dynamic Code Execution"
  description String       @db.Text // English description
  category    RuleCategory
  severity    Severity     @default(WARNING)
  
  // Abstract pattern definition
  patternType   PatternType
  patternConfig Json        // { functionNames: [...], variablePattern: "...", etc }
  
  // Metadata
  tags        String[]     // ["security", "critical", "owasp"]
  isActive    Boolean      @default(true)
  
  // Relations
  generatedQueries GeneratedQuery[]
  
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
}

// Language Adapter - Maps abstract concepts to Tree-sitter node types
// One adapter per supported language
model LanguageAdapter {
  id              String   @id @default(cuid())
  language        String   @unique  // "javascript", "python", "java"
  displayName     String             // "JavaScript", "Python", "Java"
  fileExtensions  String[]           // [".js", ".jsx", ".mjs"]
  
  // Tree-sitter grammar info
  treeSitterGrammar String           // "tree-sitter-javascript"
  
  // Node type mappings (abstract concept → language-specific node type)
  nodeTypeMappings Json              // { "FUNCTION_CALL": "call_expression", ... }
  
  // Query templates (pattern type → template string)
  queryTemplates   Json              // { "FUNCTION_CALL_BY_NAME": "...", ... }
  
  // Language-specific config
  namingConvention String            // "camelCase", "snake_case", "PascalCase"
  
  // Relations
  generatedQueries GeneratedQuery[]
  
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// Generated Query - Cached Tree-sitter query for rule+language combination
// Auto-generated from AbstractRule + LanguageAdapter
model GeneratedQuery {
  id          String   @id @default(cuid())
  
  ruleId      String
  rule        AbstractRule @relation(fields: [ruleId], references: [id], onDelete: Cascade)
  
  languageId  String
  language    LanguageAdapter @relation(fields: [languageId], references: [id], onDelete: Cascade)
  
  // The actual Tree-sitter query
  treeSitterQuery String @db.Text
  
  // Validation status
  isValidated Boolean  @default(false)
  validatedAt DateTime?
  
  // Cache management
  generatedAt DateTime @default(now())
  
  @@unique([ruleId, languageId])
}

// Pattern types for abstract rules
enum PatternType {
  FUNCTION_CALL        // Detect specific function/method calls
  ASSIGNMENT           // Detect variable assignments matching pattern
  FUNCTION_DECLARATION // Detect function/method declarations
  CLASS_DECLARATION    // Detect class definitions
  TRY_CATCH           // Detect try-catch blocks
  IMPORT              // Detect import/require statements
  LOOP                // Detect loop constructs
  CONDITIONAL         // Detect if/switch statements
  LITERAL             // Detect specific literals
  BINARY_EXPRESSION   // Detect binary operations (==, !=, etc)
  MEMBER_ACCESS       // Detect property/method access
  COMMENT             // Detect comment patterns
}

enum RuleCategory {
  SECURITY
  NAMING
  STYLE
  BEST_PRACTICE
  PERFORMANCE
  ACCESSIBILITY
}

// Legacy model - kept for backward compatibility
// TODO: Migrate existing data to new architecture
model RuleTemplate {
  id          String   @id @default(cuid())
  name        String
  description String   @db.Text
  category    RuleCategory
  language    String
  treeSitterQuery String @db.Text
  severity    Severity @default(WARNING)
  tags        String[]
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// ============================================================
// CI/CD HEALING AGENT MODELS (Phase 1.2)
// ============================================================

// Tracks a single end-to-end healing agent run 
// (triggered from the dashboard with a repo URL + team info)
model AgentRun {
  id           String    @id @default(cuid())

  // Input
  repoUrl      String              // e.g. "https://github.com/org/repo"
  repoOwner    String              // e.g. "org"
  repoName     String              // e.g. "repo"
  teamName     String              // e.g. "RIFT ORGANISERS"
  leaderName   String              // e.g. "Saiyam Kumar"
  branchName   String              // e.g. "RIFT_ORGANISERS_SAIYAM_KUMAR_AI_Fix"

  // Run lifecycle
  status       RunStatus @default(QUEUED)
  startedAt    DateTime  @default(now())
  completedAt  DateTime?

  // Results
  totalFailures   Int  @default(0)  // Failures detected
  totalFixes      Int  @default(0)  // Fixes successfully applied
  totalCommits    Int  @default(0)  // Commits made (for efficiency penalty)
  cicdStatus      CICDResult?       // Final pipeline result
  iterationsUsed  Int  @default(0)  // How many retry loops were needed

  // Scoring (computed at end of run)
  scoreBase             Int @default(100)
  scoreSpeedBonus       Int @default(0)
  scoreEfficiencyPenalty Int @default(0)
  scoreFinal            Int @default(100)

  // Relations
  fixes      Fix[]
  cicdRuns   CICDRun[]

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

// A single code fix applied by the agent during a run
model Fix {
  id         String  @id @default(cuid())
  agentRunId String
  agentRun   AgentRun @relation(fields: [agentRunId], references: [id], onDelete: Cascade)

  // Location
  filePath   String  // e.g. "src/utils.py"
  lineNumber Int     // e.g. 15

  // Classification (matches hackathon bug type categories)
  bugType    BugType // LINTING | SYNTAX | LOGIC | TYPE_ERROR | IMPORT | INDENTATION

  // What was done
  commitMessage  String  @db.Text  // Full commit message with [AI-AGENT] prefix
  commitSha      String?           // SHA of the commit that applied this fix
  originalCode   String? @db.Text  // Code before fix (for reference)
  fixedCode      String? @db.Text  // Code after fix

  // Outcome
  status     FixStatus @default(PENDING)  // FIXED | FAILED | PENDING

  createdAt  DateTime @default(now())
}

// A single CI/CD pipeline run triggered by the agent 
// (one entry per push/retry iteration)
model CICDRun {
  id         String   @id @default(cuid())
  agentRunId String
  agentRun   AgentRun @relation(fields: [agentRunId], references: [id], onDelete: Cascade)

  // Which iteration this is (1-based, max = configurable retry limit)
  iteration  Int

  // GitHub Actions workflow info
  workflowRunId  String?   // GitHub Actions run ID
  result         CICDResult  // PASSED | FAILED | TIMED_OUT

  // Timing
  triggeredAt    DateTime  @default(now())
  completedAt    DateTime?

  createdAt   DateTime @default(now())
}

// ============================================================
// ENUMS FOR HEALING AGENT
// ============================================================

enum RunStatus {
  QUEUED       // Job in BullMQ, not yet started
  RUNNING      // Agent actively working
  COMPLETED    // All tests pass
  FAILED       // Exhausted retries, tests still failing
  ERROR        // Unexpected error during run
}

enum FixStatus {
  PENDING  // Fix generated, not yet committed
  FIXED    // Fix applied and committed successfully
  FAILED   // Fix failed to apply or caused new errors
}

enum BugType {
  LINTING
  SYNTAX
  LOGIC
  TYPE_ERROR
  IMPORT
  INDENTATION
}

enum CICDResult {
  PASSED
  FAILED
  TIMED_OUT
}

